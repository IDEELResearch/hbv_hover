---
title: "HOVER data summary"
output:
  html_document:
    body_placement: left
    code_folding: hide
    toc_float:                                                             
      collapse: true                                                      
      smooth_scroll: true 
header-includes:
  - \usepackage{titling}
  - \pretitle{\begin{flushleft}}
  - \posttitle{\end{flushleft}}
---

```{r setup, include=FALSE, warning=FALSE, echo=TRUE}
knitr::opts_chunk$set(echo = TRUE)

options(dplyr.summarise.inform = FALSE)

library(tidyverse)
library(knitr)
library(stringr)
library(viridis)
library(scales)
library(sf)
library(tmap)    # for static and interactive maps
library(leaflet) # for interactive maps
library(tmaptools)
library(OpenStreetMap)
library(REDCapR)
library(readr)
library(lubridate)

drc_colors <- c("#007fff", 	"#ce102f", 	"#f7d618")
# dichot_colors <- scale_fill_viridis(option="magma", begin=0.1, end=0.58, discrete = T)
# dichot_colors <- c(viridis(1, begin=0.1,end = 0.1),viridis(1, begin=0.58,end = 0.58) )
hbvcolors <- c('#00429d', '#93003a',"#A0A0A0") #C7427CFF

# read data
# API route
data0 <- redcap_read_oneshot(redcap_uri = "https://global.redcap.unc.edu/api/",
                         token = read_file("hover_api.txt"))$data
# save as backup
# data0_april21 <- data0
# backup route via export/import
# data0 <- read.csv('ParrHOVERHBV_DATA_2021-03-04_0850.csv')

#subset data to all valid IDs
# remove duplicate Menage1 
data1<- data0 %>% 
  dplyr::filter(hrhhid!="Menage1" & hrhhid!="HRK2003" &hrhhid!="HRB1010-02" & hrhhid!="HRB-1010-01" & hrhhid!="HRB 1011-01") 
  #dplyr::mutate(hrhhid=toupper(hrhhid)) %>% 
  # %>% dplyr::mutate(h10_hbv_rdt=factor(h10_hbv_rdt,
  #                  levels=c("0","1","99"),
  #                  labels = c("HBV-","HBV+","Unknown")))

# select household entries
hhdata1 <- data1[(is.na(data1$redcap_repeat_instrument)), ]
# for hh dataset, select only hh variables
hhdata1 <- hhdata1 %>% 
  dplyr::select(starts_with("h"), "questionnaire_menage_complete")
# table(hhdata1$hxcoord, useNA = "always") #check if any non-missing GPS coords of hh are same (duplicate hh)
# save GPS coords as numeric
hhdata1$hxcoord <- as.numeric(hhdata1$hxcoord)
hhdata1$hycoord <- as.numeric(hhdata1$hycoord)

# select individual entries
inddata1 <- data1[!is.na(data1$redcap_repeat_instrument),] #data1$redcap_repeat_instrument=="questionnaire_individuel"
# select only individual variables
inddata1 <- inddata1 %>% 
  dplyr::select("hrhhid", "redcap_repeat_instance", "participant_code", starts_with("hr"), starts_with("i"))

# add index mother HBV status (HBV status of hh)
inddata1 <- left_join(inddata1, hhdata1[, c("hrhhid", "h10_hbv_rdt")], by = "hrhhid")

inddata1 <- inddata1 %>% relocate("h10_hbv_rdt", .after = "participant_code")
inddata1<- inddata1 %>% 
  dplyr::filter(hrhhid!="HRB1010-02" & hrhhid!="HRB-1010-01" & hrhhid!="HRK2003")

# source("0_HOVER_CleaningData.R")
# subset issues
# indcheck <- inddata1[inddata1$hrhhid=="HRB1010-02" | inddata1$hrhhid=="HRB-1010-01" | inddata1$hrhhid=="HRB -1010",]
# indcheck_kul <- indcheck[indcheck$hrname_last=="KULEVA" & !is.na(indcheck$hrname_last),]

# i18_hbv_percep_serious different 
```

<br> 

```{r warning=FALSE, echo=TRUE}
downloaddate0=as.Date(Sys.Date(),format="%Y-%m-%d")
downloaddate=format(downloaddate0, format="%B %d %Y")
# total hh enrolled
totalhh_enrolled <- nrow(hhdata1)

# counts by HBV status
hhdenom_hbvpos <- sum(hhdata1$h10_hbv_rdt==1 & !is.na(hhdata1$hrhhid))
hhdenom_hbvneg <- sum(hhdata1$h10_hbv_rdt==0 & !is.na(hhdata1$hrhhid))


```

#### From REDCap data downloaded on `r downloaddate`

***

#### Household enrollments (n=`r totalhh_enrolled`, `r hhdenom_hbvpos` HBV+ and `r hhdenom_hbvneg` HBV- index mothers)


```{r echo=FALSE, out.width="50%", echo=TRUE}
hhdata1$h10_hbv_rdt <- as.factor(hhdata1$h10_hbv_rdt)

hhdata1 <- hhdata1 %>% 
  dplyr::mutate(h10_hbv_rdt_f=factor(
    hhdata1$h10_hbv_rdt, 
    levels = c(0, 1),
    labels = c("HBV-", "HBV+")))

hhenrolhbvstat <- hhdata1 %>% 
  dplyr::filter(!is.na(hrhhid)) %>% 
  dplyr::group_by(h10_hbv_rdt_f) %>% 
  dplyr::summarise(n=n()) %>% 
  ggplot(aes(x=h10_hbv_rdt_f, y=n, fill=h10_hbv_rdt_f))+
  geom_bar(stat = "identity", width = 0.5)+
  geom_text(aes(x=h10_hbv_rdt_f, y=n+2 ,label = n))+
  geom_hline(yintercept=100, size=2)+
  labs(x="Index mother HBV status", y="Enrollments", fill="") +
  scale_fill_manual(values = hbvcolors)+
  theme_bw()+
  theme(legend.position = "none")+
  ggtitle("Enrolled households (target: 100 in each group)")

hhenrolhbvstat

# missing data for below
ind_misspartcode_ct <- sum(is.na(inddata1$participant_code))
ind_misspartcode <- data.frame(inddata1[is.na(inddata1$participant_code),])
hhID_indpartcodeNA <- table(ind_misspartcode$hrhhid)
# count of ind entries missing identifying information
ind_miss_3 <- sum(is.na(inddata1$participant_code) & is.na(inddata1$hrname_last) &is.na(inddata1$hrname_first))
# Drop empty entries
inddata1 <- inddata1[!is.na(inddata1$participant_code) & !is.na(inddata1$hrname_last) & !is.na(inddata1$hrname_first),]
# total individuals enrolled
totalind_enrolled <- nrow(inddata1)
```

```{r warning=FALSE, echo=TRUE}
hhdata1$weeknumiso <- isoweek(hhdata1$hdov) - 6

dailyenroll <- hhdata1 %>% 
  dplyr::filter(!is.na(hrhhid)) %>% 
  dplyr::group_by(h10_hbv_rdt_f) %>% 
  #dplyr::summarise(n=n()) %>% 
  ggplot(aes(as.Date(hdov), fill=h10_hbv_rdt_f))+ #isoweek(hdov) 
  geom_bar(stat = "count", width = 0.5)+
  scale_fill_manual(values = hbvcolors)+
  #scale_fill_viridis(option="magma", begin=0.1, end=0.58, discrete = T)+
  ggtitle("Daily household enrollment")+
  scale_x_date(breaks = "1 week", date_labels = "%m/%d")+
  xlab("")+
  ylab("Number of households")+
  theme(legend.title = element_blank(),
        panel.background = element_blank())

weeklyenroll <- hhdata1 %>% 
  dplyr::filter(!is.na(hrhhid)) %>% 
  dplyr::group_by(h10_hbv_rdt_f) %>% 
  #dplyr::summarise(n=n()) %>% 
  ggplot(aes(weeknumiso, fill=h10_hbv_rdt_f))+ #isoweek(hdov) 
  geom_bar(stat = "count", width = 0.5)+
  scale_fill_manual(values = hbvcolors)+
  #scale_fill_viridis(option="magma", begin=0.1, end=0.58, discrete = T)+
  ggtitle("Household enrollment by week")+
  #scale_x_date(breaks = "1 week", date_labels = "%m/%d")+
  xlab("Weeks since study launch")+
  ylab("Number of households")+
  theme(legend.title = element_blank(),
        panel.background = element_blank())

weeklyenroll
```


```{r warning=FALSE, echo=T, eval=F}
# attempting plot with cumulative enrollment 
hhdata1 %>% 
  dplyr::filter(!is.na(hrhhid)) %>% 
  dplyr::group_by(h10_hbv_rdt) %>% 
  ggplot(aes(as.Date(hdov)))+
  
ggplot(hhdata1 %>% group_by(h10_hbv_rdt) %>% mutate(cv=summarise(n(h10_hbv_rdt))), 
      aes(x = as.Date(hdov), y = cv, colour = factor(h10_hbv_rdt))) + 
  geom_line(size = 1)+
  geom_point() 
```


```{r echo=FALSE, out.width="50%", echo=F, eval=F}
# keeping this code chunk for creating matrix and plot of sum counts
totalhh_enrolled_df <- data.frame(totalhh_enrolled)
current_fortarget <- data.frame(c(hhdenom_hbvpos, hhdenom_hbvneg))
names(current_fortarget)[1] <- "currentnos"
current_fortarget$hbvstat <- c("HBVpos", "HBVneg")

ggplot(current_fortarget)+
  geom_bar(stat = "identity", aes(x=hbvstat, y=currentnos, fill=hbvstat))+
  scale_fill_manual(values = hbvcolors)+
  geom_hline(yintercept=100)+
  labs(x="Household index mother HBV status", y="Enrollments", fill="") +
  ggtitle("Progress to target household enrollment")+
  theme_bw()+
  theme(legend.position = "none")

```

#### Individuals enrolled by index mother HBV status (n=`r totalind_enrolled`, excluding `r ind_miss_3` with empty entries) 

```{r warning=FALSE, out.width="50%", echo=TRUE}
inddata1$h10_hbv_rdt <- as.factor(inddata1$h10_hbv_rdt)

inddata1 <- inddata1 %>% 
  dplyr::mutate(h10_hbv_rdt_f=factor(
    inddata1$h10_hbv_rdt, 
    levels = c(0, 1),
    labels = c("HBV-", "HBV+")))
  
ind_hh_hbvstat <- inddata1 %>% 
  dplyr::filter(!is.na(hrhhid)) %>% 
  dplyr::group_by(h10_hbv_rdt_f) %>% 
  dplyr::summarise(n=n()) %>% 
  ggplot(aes(x=h10_hbv_rdt_f, y=n, fill=h10_hbv_rdt_f))+
  geom_bar(stat = "identity", width = 0.5)+
  geom_text(aes(x=h10_hbv_rdt_f, y=n+6 ,label = n))+
  labs(x="Index mother HBV status", y="Enrollments", fill="") +
  scale_fill_manual(values = hbvcolors)+
  theme_bw()+
  theme(legend.position = "none")+
  ggtitle("Enrolled participants by index mother HBV status")
ind_hh_hbvstat
```

#### Index mothers enrolled

```{r warning=FALSE, out.width="50%", echo=TRUE}
# check one index mother enrolled per household
countbyindtype <- inddata1 %>%
  group_by(hrhhid, hr3_relationship) %>% summarize(n=n())
# keep just index mothers and remove paricipant type column
countbyindtype <- countbyindtype[countbyindtype$hr3_relationship==1 & !is.na(countbyindtype$hrhhid), ]

# IDs with more than one index mother enrolled
#mult.index.mother.hhid <- print(countbyindtype$hrhhid[countbyindtype$n>1])
mult.index.mother.hhid <- (countbyindtype$hrhhid[countbyindtype$n>1])


# unique IDs with at least one index mother
uniqueIDs.with.indexmother <- countbyindtype %>%
  group_by(hrhhid) %>% summarize(n=n())

hhIDs <- hhdata1 %>%
  group_by(hrhhid) %>% summarize(n=n())
# HH enrolled without an index mother
hhid.no.indexmo <- setdiff(hhIDs, uniqueIDs.with.indexmother)
hhid.no.indexmo <- hhid.no.indexmo$hrhhid

```

Household IDs with more than one index mother: `r mult.index.mother.hhid`  

Household IDs with no index mother enrolled: `r hhid.no.indexmo`  


```{r echo=FALSE, warning=FALSE, echo=TRUE}

# RDT data
ind_rdtdone <- sum(inddata1$i27_rdt_done==1, na.rm = TRUE)
ind_rdtnotdone <- sum(inddata1$i27_rdt_done ==0 & !is.na(inddata1$hrhhid), na.rm = TRUE)
ind_rdtNA <- sum(is.na(inddata1$i27_rdt_done) & !is.na(inddata1$hrhhid), na.rm = TRUE)

```

#### RDT data

`r ind_rdtdone` RDTs done, `r ind_rdtnotdone` RDTs not done (reasons below), and `r ind_rdtNA` missing.

```{r echo=FALSE, warning=FALSE, echo=TRUE}
table(inddata1$i27_rdt_notdone_reason[inddata1$i27_rdt_done==0])
```


#### Individual HBV RDT results

```{r echo=FALSE, warning=FALSE, out.width="50%", echo=TRUE}
inddata1$i27a_rdt_result <- as.factor(inddata1$i27a_rdt_result)
inddata1$participant_code <- as.numeric(inddata1$participant_code)


inddata1 <- inddata1 %>% 
  dplyr::mutate(i27a_rdt_result_f=factor(
    inddata1$i27a_rdt_result, 
    levels = c(0, 1),
    labels = c("Negative", "Positive")))

ind_hbvstat <- inddata1 %>%
  dplyr::filter(i27_rdt_done==1) %>% 
  dplyr::group_by(h10_hbv_rdt_f, i27a_rdt_result_f) %>% 
  dplyr::summarise(n=n()) %>% 
  ggplot(aes(fill=i27a_rdt_result_f, x=h10_hbv_rdt_f, y=n))+
  geom_bar(position = "dodge", stat="identity")+
  geom_text(aes(x=h10_hbv_rdt_f, y=n+5 ,label = n), position=position_dodge(width=0.9))+
  labs(x="Index mother HBV status", fill="RDT result")+
  scale_fill_manual(values = hbvcolors)+
  ggtitle("HBV RDT result of RDTs completed")+
  theme(panel.background = element_blank())

ind_hbvstat

ind_hbvstat_mothers <- inddata1 %>%
  dplyr::filter(i27_rdt_done==1 & hr3_relationship==1) %>% 
  dplyr::group_by(h10_hbv_rdt_f, i27a_rdt_result_f) %>% 
  dplyr::summarise(n=n()) %>% 
  ggplot(aes(fill=i27a_rdt_result_f, x=h10_hbv_rdt_f, y=n))+
  geom_bar(position = "dodge", stat="identity")+
  geom_text(aes(x=h10_hbv_rdt_f, y=n+1.5 ,label = n), position=position_dodge(width=0.9))+
  labs(x="Index mother HBV status", fill="RDT result")+
  scale_fill_manual(values = hbvcolors)+
  ggtitle("HBV RDT result of index mothers")+
  theme(panel.background = element_blank())

ind_hbvstat_mothers

ind_hbvstat_noindex <- inddata1 %>%
  dplyr::filter(i27_rdt_done==1 & hr3_relationship!=1) %>% 
  dplyr::group_by(h10_hbv_rdt_f, i27a_rdt_result_f) %>% 
  dplyr::summarise(n=n()) %>% 
  ggplot(aes(fill=i27a_rdt_result_f, x=h10_hbv_rdt_f, y=n))+
  geom_bar(position = "dodge", stat="identity")+
  geom_text(aes(x=h10_hbv_rdt_f, y=n+5 ,label = n), position=position_dodge(width=0.9))+
  labs(x="Index mother HBV status", fill="RDT result")+
  scale_fill_manual(values = hbvcolors)+
  ggtitle("HBV RDT result of non-index mothers")+
  theme(panel.background = element_blank())

ind_hbvstat_noindex

### which HBV exposed have RDT-
#indexmoRDTdone <- inddata1[inddata1$i27_rdt_done==1 & inddata1$hr3_relationship==1 & inddata1$h10_hbv_rdt==1,]
#table(indexmoRDTdone$hrhhid, indexmoRDTdone$i27a_rdt_result, useNA = "always")
#table(inddata1$i27a_rdt_result, useNA = "always")

# indmo <- inddata1[inddata1$hr3_relationship==1,]

# table(indmo$hrhhid,indmo$i27a_rdt_result_f, indmo$h10_hbv_rdt)
#1029 is hh that was negative


```


#### Family members of index mothers with positive RDT

```{r echo=FALSE, warning=FALSE, out.width="50%", echo=TRUE}
inddata1 <- inddata1 %>% 
  dplyr::mutate(hr3_relationship_f=factor(
    inddata1$hr3_relationship, 
    levels = c(0, 1,2,3,4,5,6,7,8,9,10,11,12,13,97,98,99),
    labels = c("Unrelated", "Index mother","Spouse","Son/daughter","Step-son/daughter","Grandson/daughter","Father/mother","In-laws","Brother/sister","Nephew/niece","Nephew/niece by marriage","Adopted/in custody","Aunt/uncle","Grandmother/father","Other","Don't know", "Refused")))

ind.with.rdt <- inddata1[inddata1$i27a_rdt_result==1 &inddata1$hr3_relationship!=1,]

table(ind.with.rdt$hrhhid, droplevels(ind.with.rdt$hr3_relationship_f))
table(ind.with.rdt$h10_hbv_rdt_f, droplevels(ind.with.rdt$hr3_relationship_f))

```

#### Age (years) of RDT+ participants (non-index mothers) by index mother status

```{r echo=FALSE, warning=FALSE, out.width="50%", echo=TRUE}
# age
inddata1$age_combined <- round(ifelse(as.numeric(inddata1$hr7a_month_year==0), as.numeric(inddata1$hr7_age_year), as.numeric(inddata1$hr7_age_mois)/12),2)

table(inddata1$age_combined[inddata1$i27a_rdt_result==1 &inddata1$hr3_relationship!=1], inddata1$h10_hbv_rdt_f[inddata1$i27a_rdt_result==1 &inddata1$hr3_relationship!=1])
```

***

#### Age distribution

```{r echo=FALSE, warning=FALSE, out.width="50%", echo=TRUE}
# Age 

age_dist <- ggplot(inddata1)+
  geom_histogram(aes(x=age_combined, fill=h10_hbv_rdt_f), bins = 40)+
  labs(x="Age (in years)", fill="HH HBV status")+
  scale_fill_manual(values = hbvcolors)+
  ggtitle("Age distribution by index mother HBV status")

age_dist
```

#### Sex of enrollees

```{r echo=FALSE, warning=FALSE, out.width="50%", echo=TRUE}
# Sex 
inddata1 <- inddata1 %>% 
  dplyr::mutate(hr4_sex_f=factor(
    inddata1$hr4_sex, 
    levels = c(0, 1),
    labels = c("Male", "Female")))
# table(inddata1$hr4_sex_f)

ggplot(inddata1, aes(fill=hr4_sex_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
  scale_fill_manual(values = c('#73a2c6','#f4777f'))+
  #scale_fill_viridis(option="magma", begin=0.1, end=0.58, discrete = T)+
  ggtitle("Sex of enrollees by hh HBV status")+
  theme(panel.background = element_blank())

```

#### Map of enrolled households

```{r echo=FALSE, warning=FALSE, echo=TRUE}
# latitudes are below equator, so need to be negative decimal degrees
options(scipen = 999)
#locations of Binza and Kingasani maternity centers
centers <- c("Binza","Kingasani")
lat <- c(-4.382935, -4.402250)
long <- c(15.261066, 15.408503)
maternities <- as.data.frame(cbind(centers, lat, long))
matgps <- st_as_sf(maternities, coords = c("long","lat"), crs= 4326)
# Binza -4.382935, 15.261066
# Kingasani -4.402250, 15.408503
# check GPS data formatting
# test_2 <- subset(hhdata1, select = c("hrhhid", "hycoord", "hxcoord"))
# floor(log10(test_2$hxcoord))
hhdata1$hycoord_edit <- ifelse(floor(log10(hhdata1$hycoord))==7,
                              hhdata1$hycoord/1000000,
                                ifelse(floor(log10(hhdata1$hycoord))==6,hhdata1$hycoord/100000,
                                       hhdata1$hycoord))
hhdata1$hxcoord_edit <- ifelse(floor(log10(hhdata1$hxcoord))==5,
                              hhdata1$hxcoord/100000,
                              hhdata1$hxcoord)
# table(hhdata1$hxcoord_edit)
# hhdata1 <- subset(hhdata1, select = -c(hycoord_edit))

hhdata1$hxcoord_edit <- (hhdata1$hxcoord_edit)*-1
hover_gps = st_as_sf(hhdata1[!is.na(hhdata1$hxcoord_edit) &!is.na(hhdata1$hycoord_edit),], coords = c("hycoord_edit", "hxcoord_edit"), crs = 4326)  

hover_gps <- subset(hover_gps, select=c( "h10_hbv_rdt_f" , "hrhhid","geometry"))
# hover_gps$h10_hbv_rdt <-as.factor(hover_gps$h10_hbv_rdt)
# interactive map
 tmap_mode("view")
# tmap_mode("plot")
tm_basemap("OpenStreetMap") +
  tm_shape(st_jitter(hover_gps, factor=0.005)) + 
    tm_dots(col = "h10_hbv_rdt_f", palette=c('#00429d', '#93003a'),id="hrhhid")+
#tm_basemap("OpenStreetMap") +
  tm_shape(matgps)+
    tm_dots(col = "#ffffbf", id="centers", shapes = 23) #ffffe0

#popup.vars=("HH ID"="hrhhid")
#   tm_dots(col = as.factor("h10_hbv_rdt"), palette=c('#00429d', '#93003a'),id="hrhhid") #popup.vars=("HH ID"="hrhhid")


## static map
# tmap_mode("plot")
#osm <- read_osm(st_bbox(hover_gps)+c(-0.2,-0.2,0.2,0.2))
#tm_shape(osm) +
#  tm_rgb() +
#tm_shape(hover_gps) +
#  tm_dots("red", size = 0.5)

```
*Points are randomly offset to protect privacy  


#### Other questions of interest

```{r echo=FALSE, warning=FALSE, out.width="50%", echo=TRUE}
# Vaccination 
vacc_elig <- sum(inddata1$i39_vaccine_eligible==1)
vacc_consent <- sum(inddata1$i39a_vac_consent[inddata1$i39_vaccine_eligible==1])
vacc_noconsent <- sum(inddata1$i39a_vac_consent==0 & inddata1$i39_vaccine_eligible==1)
# table(inddata1$i39_vac_whynot) # need to code these reasons
```

##### Vaccination
`r vacc_elig` are eligible for the HBV vaccination, `r vacc_consent` gave consent to receive it. `r vacc_noconsent` did not give consent.

```{r echo=FALSE, warning=FALSE, out.width="50%", echo=TRUE, eval=F}
table(inddata1$i39_vaccine_eligible, useNA = "always")
class(inddata1$i39_vaccine_eligible)
# reasons consent not given
table(inddata1$i39_vac_whynot) # need to code these reasons
inddata1 %>% group_by(i39_vac_whynot) %>% summarize(n=n())

vacc.refuse.elig <- inddata1[inddata1$i39_vaccine_eligible==1 & inddata1$i39a_vac_consent==0, c("hrhhid","participant_code","i39_vaccine_eligible","i39a_vac_consent","i39_vac_whynot")]
vacc.refuse.elig.reason <- inddata1[!is.na(inddata1$i39_vac_whynot),c("hrhhid","participant_code","i39_vaccine_eligible","i39a_vac_consent","i39_vac_whynot")]
```

##### Individual characteristics

```{r echo=FALSE, warning=FALSE, out.width="50%", echo=TRUE}
#primary residence 
inddata1 <- inddata1 %>% 
  dplyr::mutate(hr5_primary_residence_f=factor(
    inddata1$hr5_primary_residence, 
    levels = c(0, 1, 99),
    labels = c("No", "Yes", "Refused")))

ggplot(inddata1, aes(fill=hr5_primary_residence_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
  scale_fill_manual(values = c('#73a2c6','#f4777f','#ffffe0','#00429d'))+
  #scale_fill_manual(values = hbvcolors)+
  ggtitle("Primary residence of enrolled individuals")+
  theme(panel.background = element_blank())

# slept in this hh last night
inddata1 <- inddata1 %>% 
  dplyr::mutate(hr6_last_night_residence_f=factor(
    inddata1$hr6_last_night_residence, 
    levels = c(0, 1, 99),
    labels = c("No", "Yes", "Refused")))

ggplot(inddata1, aes(fill=hr6_last_night_residence_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
  scale_fill_manual(values = c('#73a2c6','#f4777f','#ffffe0','#00429d'))+
  ggtitle("Slept in this household last night")+
  theme(panel.background = element_blank())

# occupation

#past positive test
inddata1 <- inddata1 %>% 
  dplyr::mutate(i2_past_hbv_dx_f=factor(
    inddata1$i2_past_hbv_dx, 
    levels = c(0, 1, 3,98,99),
    labels = c("No", "Yes", "Never tested", "Don't know", "Refused")))

#scale_fill_manual(values = c('#73a2c6','#f4777f','#ffffe0','#00429d','#93003a'))+

ggplot(inddata1, aes(fill=i2_past_hbv_dx_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
  scale_fill_manual(values = c('#73a2c6','#f4777f','#ffffe0','#00429d','#93003a'))+
  #scale_fill_manual(values = c('#00429d', '#73a2c6', '#ffffe0', '#f4777f', '#93003a'))+
  ggtitle("Past HBV diagnosis")+
  theme(panel.background = element_blank())

#table(inddata1$hr6_last_night_residence)

#past positive test
inddata1 <- inddata1 %>% 
  dplyr::mutate(i1_hbv_positive_f=factor(
    inddata1$i1_hbv_positive, 
    levels = c(0, 1,2, 3,98,99),
    labels = c("No", "Yes, once","Yes, more than once", "Never tested", "Don't know", "Refused")))

ggplot(inddata1, aes(fill=i1_hbv_positive_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
  scale_fill_manual(values = c('#73a2c6','#f4777f','#93003a','#ffffe0','#00429d'))+
  ggtitle("Past HBV positive test")+
  theme(panel.background = element_blank())

# past HIV diagnosis
inddata1 <- inddata1 %>% 
  dplyr::mutate(i3_hiv_pos_test_f=factor(
    inddata1$i3_hiv_pos_test, 
    levels = c(0, 1, 3,98,99),
    labels = c("No", "Yes", "Never tested", "Don't know", "Refused")))

ggplot(inddata1, aes(fill=i3_hiv_pos_test_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
  scale_fill_manual(values = c('#73a2c6','#f4777f','#ffffe0','#00429d','#93003a'))+
  ggtitle("Past positive HIV test")+
  theme(panel.background = element_blank())

#hiv treatment
inddata1 <- inddata1 %>% 
  dplyr::mutate(i3a_hiv_treatment_f=factor(
    inddata1$i3a_hiv_treatment, 
    levels = c(0, 1, 98,99),
    labels = c("No", "Yes", "Don't know", "Refused")))

ggplot(inddata1[!is.na(inddata1$i3a_hiv_treatment_f),], aes(fill=i3a_hiv_treatment_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
  scale_fill_manual(values = c('#73a2c6','#f4777f','#ffffe0','#00429d','#93003a'))+
  ggtitle("For HIV+, currently being treated")+
  theme(panel.background = element_blank())


```

If being treated for HIV, current medications:

```{r echo=F,out.width="50%", echo=TRUE}
table(inddata1$i3b_hiv_medications)

# have you had a fever in past week
inddata1 <- inddata1 %>% 
  dplyr::mutate(i4_fever_f=factor(
    inddata1$i4_fever, 
    levels = c(0, 1, 98,99),
    labels = c("No", "Yes", "Don't know", "Refused")))

ggplot(inddata1, aes(fill=i4_fever_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
    scale_fill_manual(values = c('#73a2c6','#f4777f','#93003a','#00429d'))+ # yellow not visible '#ffffe0'
#scale_fill_manual(values = c('#73a2c6','#f4777f','#ffffe0'))+
  #scale_fill_manual(values = c('#00429d', '#73a2c6', '#ffffe0', '#f4777f', '#93003a'))+
  ggtitle("Fever in past week")+
  theme(panel.background = element_blank())

# currently pregnant
inddata1 <- inddata1 %>% 
  dplyr::mutate(i5_pregnancy_f=factor(
    inddata1$i5_pregnancy, 
    levels = c(0, 1, 98,99),
    labels = c("No", "Yes", "Don't know", "Refused")))

ggplot(inddata1[!is.na(inddata1$i5_pregnancy_f),], aes(fill=i5_pregnancy_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
  #scale_fill_manual(values = c('#73a2c6','#f4777f','#ffffe0'))+
  scale_fill_manual(values = c('#73a2c6','#f4777f','#93003a','#00429d'))+ # yellow not visible '#ffffe0'
#scale_fill_manual(values = c('#00429d', '#73a2c6', '#ffffe0', '#f4777f', '#93003a'))+
  ggtitle("Currently pregnant")+
  theme(panel.background = element_blank())

# antenatal visit

```



##### HBV potential exposures

```{r echo=F,out.width="50%", echo=TRUE, warning=F}
# Shared razors
# inddata1$i14_shared_razor <- as.factor(inddata1$i14_shared_razor)
inddata1 <- inddata1 %>% 
  dplyr::mutate(i14_shared_razor_f=factor(
    inddata1$i14_shared_razor, 
    levels = c(0, 1, 99),
    labels = c("No", "Yes", "Refused")))

ggplot(inddata1, aes(fill=i14_shared_razor_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
 # scale_fill_manual(values = hbvcolors)+   
  scale_fill_manual(values = c('#73a2c6','#f4777f','#93003a','#00429d'))+ # yellow not visible '#ffffe0'
  ggtitle("Shared razors by hh HBV status")+
  theme(panel.background = element_blank())

# shared nail clippers
inddata1 <- inddata1 %>% 
  dplyr::mutate(i15_shared_nailclippers_f=factor(
    inddata1$i15_shared_nailclippers, 
    levels = c(0, 1, 99),
    labels = c("No", "Yes", "Refused")))

ggplot(inddata1, aes(fill=i15_shared_nailclippers_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
  scale_fill_manual(values = c('#73a2c6','#f4777f','#93003a','#00429d'))+ # yellow not visible '#ffffe0'
  ggtitle("Shared nail clippers by hh HBV status")+
  theme(panel.background = element_blank())

# Transfusion 
inddata1 <- inddata1 %>% 
  dplyr::mutate(i8_transfusion_f=factor(
    inddata1$i8_transfusion, 
    levels = c(0, 1, 99),
    labels = c("No", "Yes", "Refused")))
ggplot(inddata1, aes(fill=i8_transfusion_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
  scale_fill_manual(values = c('#73a2c6','#f4777f','#93003a','#00429d'))+ # yellow not visible '#ffffe0'
  ggtitle("Transfusion by hh HBV status")+
  theme(panel.background = element_blank())

#  i9_iv_drug_use

inddata1 <- inddata1 %>% 
  dplyr::mutate(i9_iv_drug_use_f=factor(
    inddata1$i9_iv_drug_use, 
    levels = c(0, 1, 99),
    labels = c("No", "Yes", "Refused")))
ggplot(inddata1, aes(fill=i9_iv_drug_use_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
  scale_fill_manual(values = c('#73a2c6','#f4777f','#93003a','#00429d'))+ # yellow not visible '#ffffe0'
  ggtitle("IVDU by hh HBV status")+
  theme(panel.background = element_blank())
# which drug
table(inddata1$i9a_iv_durg_use_list)

#  i10_street_salon
inddata1 <- inddata1 %>% 
  dplyr::mutate(i10_street_salon_f=factor(
    inddata1$i10_street_salon, 
    levels = c(0, 1, 99),
    labels = c("No", "Yes", "Refused")))
ggplot(inddata1, aes(fill=i10_street_salon_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
  scale_fill_manual(values = c('#73a2c6','#f4777f','#93003a','#00429d'))+ # yellow not visible '#ffffe0'
  ggtitle("Street salon by hh HBV status")+
  theme(panel.background = element_blank())


#  i10_street_salon times per month
# table(inddata1$i10a_street_salon_number, inddata1$participant_code)
# inddata1$i10a_street_salon_number_num <- as.numeric(inddata1$i10a_street_salon_number)
# table(inddata1$i10a_street_salon_number_num)
##NEEDS FIXING
# ggplot(inddata1, aes(fill=i10a_street_salon_number_num, x=h10_hbv_rdt_f))+
#  geom_bar(position = "identity")+
#  labs(x="Index mother HBV status", fill="")+
  #scale_fill_manual(values = hbvcolors)+
#  ggtitle("Street salon visits per month hh HBV status")+
#  theme(panel.background = element_blank())

# i11_manucure outside home
inddata1 <- inddata1 %>% 
  dplyr::mutate(i11_manucure_f=factor(
    inddata1$i11_manucure, 
    levels = c(0, 1, 99),
    labels = c("No", "Yes", "Refused")))
ggplot(inddata1, aes(fill=i11_manucure_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
  scale_fill_manual(values = c('#73a2c6','#f4777f','#93003a','#00429d'))+ # yellow not visible '#ffffe0'
  ggtitle("Manicure outside home by hh HBV status")+
  theme(panel.background = element_blank())

# i12_food_first_chew
inddata1 <- inddata1 %>% 
  dplyr::mutate(i12_food_first_chew_f=factor(
    inddata1$i12_food_first_chew, 
    levels = c(0, 1, 99),
    labels = c("No", "Yes", "Refused")))
ggplot(inddata1, aes(fill=i12_food_first_chew_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
  scale_fill_manual(values = c('#73a2c6','#f4777f','#93003a','#00429d'))+ # yellow not visible '#ffffe0'
  ggtitle("Chewed food/gum by hh HBV status")+
  theme(panel.background = element_blank())

# i13_shared_toothbrush

inddata1 <- inddata1 %>% 
  dplyr::mutate(i13_shared_toothbrush_f=factor(
    inddata1$i13_shared_toothbrush, 
    levels = c(0, 1, 99),
    labels = c("No", "Yes", "Refused")))
ggplot(inddata1, aes(fill=i13_shared_toothbrush_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
  scale_fill_manual(values = c('#73a2c6','#f4777f','#93003a','#00429d'))+ # yellow not visible '#ffffe0'
  ggtitle("Shared toothbrush by hh HBV status")+
  theme(panel.background = element_blank())

# i16_traditional_scarring
inddata1 <- inddata1 %>% 
  dplyr::mutate(i16_traditional_scarring_f=factor(
    inddata1$i16_traditional_scarring, 
    levels = c(0, 1, 99),
    labels = c("No", "Yes", "Refused")))
ggplot(inddata1, aes(fill=i16_traditional_scarring_f, x=h10_hbv_rdt_f))+
  geom_bar(position = "dodge")+
  labs(x="Index mother HBV status", fill="")+
  scale_fill_manual(values = c('#73a2c6','#f4777f','#93003a','#00429d'))+ # yellow not visible '#ffffe0'
  ggtitle("Traditional scarring by hh HBV status")+
  theme(panel.background = element_blank())

# Sexual history
ggplot(inddata1, aes(x=i22_sex_hx_age_1st, fill=h10_hbv_rdt_f))+
  geom_histogram(stat = "count")+
  #geom_bar(position = "dodge")+
  labs(x="Age (years)", fill="")+
  scale_fill_manual(values = hbvcolors)+
  ggtitle("Age of sexual debut \n 0=Never had sex, >95 = Refused")+
  theme(panel.background = element_blank())

```